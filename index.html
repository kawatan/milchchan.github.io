<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f6f6f6">
    <title>チャット</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css" type="text/css"
        media="screen" />
    <style>
        [v-cloak] {
            display: none;
        }

        .wf-notosansjapanese {
            font-family: "Noto Sans JP";
        }

        html {
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        body {
            position: relative;
            overflow: hidden;
            background-color: #f6f6f6;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        p,
        span,
        input {
            font-family: "Noto Sans JP";
        }

        #three {
            position: absolute;
            z-index: 0;
            display: block;
        }

        #particles-js {
            position: absolute;
            z-index: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
        }

        .columns .is-vcentered {
            align-items: center;
        }

        #heading .level .level-item .field span.icon {
            margin: 0px 8px 0px 0px;
        }

        #app {
            z-index: 1;
            position: relative;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        #heading>.columns {
            margin: 16px 0px 0px 0px;
            padding: 0;
        }

        #heading>.columns>.column {
            padding: 0;
        }

        #heading>.columns>.column>.columns {
            margin: 0;
            padding: 0;
        }

        #heading>.columns>.column>.columns>.column:first-child {
            padding: 0px 0px 0px 16px;
        }

        #heading>.columns>.column>.columns>.column {
            padding: 0;
        }

        #heading .title {
            font-family: 'Roboto Condensed', sans-serif;
        }

        #heading .navbar-item .level {
            margin: 16px 16px 16px 16px;
            padding: 0px 0px 0px 0px;
        }

        #heading .navbar-item .level:nth-child(2) {
            margin: 8px 8px 8px 8px;
            padding: 0px;
        }

        #heading .navbar-item .level:nth-last-child(3) {
            margin: 0px 0px 4px 0px;
        }

        #heading .navbar-item .level:nth-last-child(2) {
            margin: 4px 0px 0px 0px;
        }

        #heading .navbar-item .level:last-child {
            margin: 16px 0px 0px 0px;
        }

        #heading .navbar-item .level .level-item {
            margin: 0px 0px 0px 0px;
            padding: 0px 0px 0px 0px;
        }

        #heading .navbar-item .tags>.control {
            margin: 0px 0px 0px 0px;
            padding: 8px 8px 8px 8px;
        }

        #heading .tags {
            margin: 0;
            padding: 0px 0px 0px 0px;
            align-items: flex-start;
            justify-content: center;
        }

        #heading .tag {
            font-family: "Gotham";
            margin: 0;
            padding: 0px 8px 0px 8px;
        }

        #container {
            position: relative;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #container .columns {
            margin: 0;
        }

        #container .column hr {
            margin: 16px 0px 16px 0px;
            padding: 0;
            height: 0;
        }

        #container .column {
            padding: 0px 16px 0px 16px;
        }

        #input .notification {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            margin: 0px 0px 16px 0px;
            padding: 0;
        }

        #input .is-info {
            color: #ffffff;
        }

        #input .notification .media {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 500px 500px 500px 500px;
            background-image: url('/images/Stripes.png');
            background-repeat: repeat;
            padding: 8px 16px 8px 16px;
        }

        #input .notification .media .media-left {
            margin: 0px 8px 0px 0px;
        }

        #input .columns {
            margin: 0px 0px 0px 0px;
            padding: 16px 0px 16px 0px;
        }

        #input .column {
            padding: 0px 16px 0px 16px;
        }

        #input .columns .column>div:nth-last-child(2) {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0px 0px 4px 0px;
        }

        #input .control .is-primary {
            background-color: #30c0f5;
        }

        .has-content-centered {
            margin-left: auto;
            margin-right: auto;
        }

        .media-content .level {
            margin: 0px 0px 4px 0px;
        }

        .media-content .content div:last-child {
            margin: 4px 0px 0px 0px;
        }

        .media-content p {
            word-wrap: break-word;
            white-space: normal;
        }

        .media-content .has-text-left .balloon {
            display: inline-block;
            padding: 8px 16px 8px 16px;
            border-radius: 0px 500px 500px 500px;
            background-image: url('/images/Stripes.png');
            background-repeat: repeat;
        }

        .media-content .has-text-right .balloon {
            display: inline-block;
            padding: 8px 16px 8px 16px;
            border-radius: 500px 0px 500px 500px;
            background-image: url('/images/Stripes.png');
            background-repeat: repeat;
        }

        .navbar {
            background-color: transparent;
        }

        .navbar:first-child {
            position: fixed;
            z-index: 1;
            padding: env(safe-area-inset-top) 0px 0px 0px;
        }

        .navbar:first-child .navbar-item {
            margin: 0;
            padding: 0;
        }

        .navbar:last-child {
            z-index: 1;
            padding: 0px env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .navbar:last-child .columns {
            margin: 0px 0px 0px 0px;
            padding: 0px 0px 16px 0px;
        }

        .navbar:last-child .column {
            padding: 0px 0px 0px 0px;
            line-height: 0px;
        }

        .navbar-item img {
            max-height: none;
        }

        .updating {
            animation: updating 1s linear infinite;
        }

        @keyframes updating {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(-360deg);
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio:2),
        (min-resolution: 2dppx) {
            .media-content .has-text-left .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 0px 500px 500px 500px;
                background-image: url('/images/Stripes@2x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }

            .media-content .has-text-right .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 500px 0px 500px 500px;
                background-image: url('/images/Stripes@2x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio:3),
        (min-resolution: 3dppx) {
            .media-content .has-text-left .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 0px 500px 500px 500px;
                background-image: url('/images/Stripes@3x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }

            .media-content .has-text-right .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 500px 0px 500px 500px;
                background-image: url('/images/Stripes@3x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }
        }

        @font-face {
            font-family: "Gotham";
            src: url('/fonts/Gotham-Book.woff') format('woff');
            font-weight: normal;
        }

        @font-face {
            font-family: "Gotham";
            src: url('/fonts/Gotham-Bold.woff') format('woff');
            font-weight: bold;
        }
    </style>
</head>

<body>
    <canvas id="three"></canvas>
    <div id="particles-js"></div>
    <div id="app">
        <nav id="heading" class="navbar is-fixed-top" role="navigation">
            <div class="navbar-item is-expanded columns is-desktop">
                <div class="column is-half has-content-centered" v-cloak>
                    <div class="columns is-mobile">
                        <div class="column is-1 is-mobile">
                            <button class="button is-white is-hidden" @click="reveal">
                                <span class="icon is-small">
                                    <i class="fas fa-bars"></i>
                                </span>
                            </button>
                        </div>
                        <div class="column is-10 is-mobile">
                            <div class="control has-text-centered">
                                <nav class="level is-hidden">
                                    <div class="level-item has-text-centered image">
                                        <a href="/"><img src="/images/Logo.png"
                                                srcset="/images/Logo.png 1x, /images/Logo@2x.png 2x, /images/Logo@3x.png 3x"
                                                alt="milchchan.com"></a>
                                    </div>
                                </nav>
                                <nav class="level">
                                    <div class="level-item has-text-centered">

                                        <div class="field is-grouped is-vcentered">
                                            <span class="icon is-small">
                                                <i class="fas fa-book"></i>
                                            </span>
                                            <span class="title is-size-3"
                                                v-bind:class="{'is-invisible': words === -1}">{{ words }}</span>
                                        </div>



                                        <!--
                                    <div class="column">
                                        <button class="button is-white has-background-white has-text-black is-rounded"
                                            v-bind:disabled="!isReady" v-on:click="like">
                                            <span class="icon is-small">
                                                <i class="fas fa-star"></i>
                                            </span>
                                        </button>
                                        <span class="icon is-small">
                                            <i class="fas fa-book"></i>
                                        </span>
                                    </div>
                                    <div class="column">
                                        
                                    </div>
                            </div>-->
                                    </div>
                                </nav>
                                <nav class="level">
                                    <div class="level-item has-text-centered">
                                        <div class="field">
                                            <h6 class="subtitle is-size-7 is-uppercase has-text-weight-bold">覚えたことば</h6>
                                        </div>
                                    </div>
                                </nav>
                                <nav class="level" v-bind:class="{'is-hidden': !isRevealed}">
                                    <div class="level-item has-text-centered">
                                        <div class="tags are-normal field is-grouped is-grouped-multiline">
                                            <div class="control">
                                                <div class="tags has-addons">
                                                    <span class="tag is-white"><a class="has-text-black"
                                                            href="https://www.microsoft.com/store/apps/9WZDNCRDT09Q">Apricot</a></span>
                                                    <span class="tag is-black">Windows</span>
                                                </div>
                                            </div>
                                            <div class="control">
                                                <div class="tags has-addons">
                                                    <span class="tag is-white"><a class="has-text-black"
                                                            href="https://clock.milchchan.com/">Clock</a></span>
                                                    <span class="tag is-black">Web</span>
                                                </div>
                                            </div>
                                            <div class="control">
                                                <div class="tags has-addons">
                                                    <span class="tag is-white"><a class="has-text-black"
                                                            href="https://apps.apple.com/jp/app/id1130755997">Wonderland</a></span>
                                                    <span class="tag is-black">iOS</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </nav>
                            </div>
                        </div>
                        <!--<div class="column is-1 is-mobile">
                            <button class="button is-white">
                                <span class="icon is-small">
                                    <i class="fas fa-bars"></i>
                                </span>
                            </button>
                        </div>-->
                    </div>
                </div>
            </div>
        </nav>
        <div id="container">
            <div class="columns is-desktop" v-for="message in messages" v-bind:key="message.id">
                <div class="column is-half has-content-centered">
                    <hr class="is-invisible">
                    <article class="media" v-if="user.uid === message.user.id" v-cloak>
                        <div class="media-content">
                            <div class="level is-mobile" v-if="message.user.name">
                                <div class="level-left">
                                    <span
                                        class="is-size-7 has-text-weight-bold has-text-grey">{{ message.user.name }}</span>
                                </div>
                            </div>
                            <div class="content has-text-right">
                                <div class="balloon" v-bind:style="{ backgroundColor: message.user.accent }">
                                    <p class="has-text-weight-bold has-text-white">
                                        {{ message.text }}
                                    </p>
                                </div>
                                <div>
                                    <p class="is-size-7 has-text-weight-normal has-text-grey">
                                        {{ formatDate(message.timestamp) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <figure class="media-right" v-if="message.user.image">
                            <p class="image is-64x64">
                                <img class="is-rounded" v-bind:src="message.user.image" alt="Avatar">
                            </p>
                        </figure>
                    </article>
                    <article class="media" v-else v-cloak>
                        <figure class="media-left" v-if="message.user.image">
                            <p class="image is-64x64">
                                <img class="is-rounded" v-bind:src="message.user.image" alt="Avatar">
                            </p>
                        </figure>
                        <div class="media-content">
                            <div class="level is-mobile" v-if="message.user.name">
                                <div class="level-left">
                                    <span
                                        class="is-size-7 has-text-weight-bold has-text-grey">{{ message.user.name }}</span>
                                </div>
                            </div>
                            <div class="content has-text-left">
                                <div class="balloon" v-bind:style="{ backgroundColor: message.user.accent }">
                                    <p class="has-text-weight-bold has-text-white">
                                        <span v-bind:class="{'is-hidden': message.text}">
                                            <i class="fas fa-spinner updating"></i>
                                        </span>
                                        {{ message.text }}
                                    </p>
                                </div>
                                <div>
                                    <p class="is-size-7 has-text-weight-normal has-text-grey">
                                        {{ formatDate(message.timestamp) }}</p>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </div>
        <nav id="input" class="navbar is-fixed-bottom" role="navigation">
            <div class="navbar-item is-expanded columns is-desktop">
                <div class="column is-half has-content-centered is-mobile">
                    <div class="notification is-info is-light" v-if="notification" v-cloak>
                        <article class="media" v-bind:style="{ backgroundColor: notification.accent }">
                            <figure class="media-left" v-if="notification.image" v-cloak>
                                <span class="image is-32x32">
                                    <img class="is-rounded" v-bind:src="notification.image" alt="Avatar">
                                </span>
                            </figure>
                            <div class="media-content">
                                <div class="content has-text-left">
                                    <span class="has-text-weight-bold" v-cloak>
                                        {{ notification.text }}
                                    </span>
                                </div>
                            </div>
                        </article>
                    </div>
                    <div>
                        <span class="is-size-7 has-text-weight-normal has-text-grey" v-cloak>
                            {{ currentInputLength }}/{{ maxInputLength }}
                        </span>
                    </div>
                    <form onsubmit="return false;">
                        <div class="field has-addons">
                            <div class="control">
                                <button class="button is-rounded" type="button" @click="like"><span
                                        class="icon is-small">
                                        <i class="fas fa-star"></i>
                                    </span>
                                </button>
                            </div>
                            <div class="control is-expanded">
                                <input class="input is-rounded" type="text" v-bind:class="{'is-danger': inputHasError}"
                                    v-model="input" @input="change">
                            </div>
                            <div class="control">
                                <button class="button is-rounded is-primary" type="submit"
                                    v-bind:class="{'is-loading': isLoading}" v-bind:disabled="user === null"
                                    @click="send"><span class="icon is-small">
                                        <i class="fas fa-paper-plane"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </nav>
        <audio id="send" preload="auto">
            <source src="/sounds/plastic_hi.wav" type="audio/wav" />
        </audio>
        <audio id="recieve" preload="auto">
            <source src="/sounds/plastic_lo.wav" type="audio/wav" />
        </audio>
        <audio id="like" preload="auto">
            <source src="/sounds/plastic_up_hi.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-database.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="https://unpkg.com/three@0.106.2/build/three.js"></script>
    <script src="https://unpkg.com/three@0.106.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.106.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="/js/moment-with-locales.js"></script>
    <script src="/js/three-vrm.js"></script>
    <script src="/js/particles.js"></script>
    <script src="/js/tiny-segmenter.js"></script>
    <script type="text/javascript">
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDTVxDJj7rqG9L-Clvba2Tao9B0hkcxjcE",
            authDomain: "milchchan.firebaseapp.com",
            databaseURL: "https://milchchan.firebaseio.com",
            projectId: "milchchan",
            storageBucket: "milchchan.appspot.com",
            messagingSenderId: "355698971889",
            appId: "1:355698971889:web:e3653c5c31bd7289cd4550",
            measurementId: "G-3998FJYNWX"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        const debug = getParameterByName("debug") || false;
        const channel = decodeURIComponent(window.location.hash.substring(1));
        const databaseRoot = 'chat';
        const databaseChannel = channel.length > 0 ? databaseRoot + '/channels/' + channel : databaseRoot;
        const databaseMessages = databaseChannel + '/messages';
        let database = firebase.database();
        const user = { accent: '#30c0f5' };
        const milch = { name: 'ミルヒちゃん', accent: '#ffa6bb', image: '/images/Milch.png' };
        const merku = { name: 'メルクちゃん', accent: '#5bcbe1', image: '/images/Merku.png' };
        let segmenter = new TinySegmenter();

        //databaseRoot.remove();

        /*databaseRoot.remove().orderByChild('timestamp')
            .startAt(1).limitToFirst(2)
            .once('value', function (snapshot) { console.log(snapshot.val()) })*/

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");

            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
            var results = regex.exec(window.location.href);

            if (results == null) {
                return null;
            }

            return decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        //document.title += ' #' + channel;

        //var channel = getParameterByName("channel") || getParameterByName("ch") || "";

        const renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById("three"),
            alpha: true
        });

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setClearColor(0xffffff, 0);

        if (channel.length > 0) {
            renderer.domElement.classList.add("is-hidden");
        }

        const CAMERA_FOV = 60.0;
        const CAMERA_Z = -1.0;
        const camera = new THREE.PerspectiveCamera(CAMERA_FOV, window.innerWidth / window.innerHeight, 0.1, 1000);

        camera.position.set(0.0, 1.25, CAMERA_Z);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        controls.screenSpacePanning = true;
        controls.target.set(0.0, 1.0, 0.0);
        controls.update();

        const scene = new THREE.Scene();
        const light = new THREE.DirectionalLight(0xffffff);

        light.intensity = 1;
        light.position.set(0.0, 10.0, -10.0).normalize();

        scene.add(light);
        //scene.add(new THREE.GridHelper(10, 10));
        //scene.add(new THREE.AxesHelper(5));

        const lookAtTarget = new THREE.Object3D();

        camera.add(lookAtTarget);

        let currentVrm = null;
        let currentMixer = null;
        const loader = new THREE.GLTFLoader();

        loader.crossOrigin = "anonymous";
        loader.load(
            "/models/Milch.vrm",
            (gltf) => {
                THREE.VRM.from(gltf).then((vrm) => {
                    currentVrm = vrm;

                    scene.add(vrm.scene);

                    //vrm.humanoid.getBoneNode(THREE.VRMSchema.HumanoidBoneName.Hips).rotation.y = Math.PI;

                    //currentMixer = prepareAnimation(vrm);

                    vrm.lookAt.target = lookAtTarget;
                });
            },
            (progress) => app.progress = progress.loaded / progress.total,
            (error) => console.error(error)
        );

        /*var dropZone = document.getElementById("three");

        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
            event.dataTransfer.dropEffect = "copy";
        }, false);
        dropZone.addEventListener("drop", (event) => {
            event.stopPropagation();
            event.preventDefault();

            for (let file of event.dataTransfer.files) {
                let reader = new FileReader();

                reader.addEventListener("load", (e) => {
                    loader.load(
                        e.target.result,
                        (gltf) => {
                            THREE.VRM.from(gltf).then((vrm) => {
                                if (currentVrm != null) {
                                    scene.remove(currentVrm.scene);
                                }

                                currentVrm = vrm;

                                scene.add(vrm.scene);

                                //vrm.humanoid.getBoneNode(THREE.VRMSchema.HumanoidBoneName.Hips).rotation.y = Math.PI;

                                //currentMixer = prepareAnimation(vrm);

                                vrm.lookAt.target = lookAtTarget;
                            });
                        },
                        (progress) => app.progress = progress.loaded / progress.total,
                        (error) => console.error(error)
                    );
                });
                reader.readAsDataURL(file);

                break;
            }

        }, false);*/

        /*function prepareAnimation(vrm) {
            const mixer = new THREE.AnimationMixer(vrm.scene);
            const blinkTrack = new THREE.NumberKeyframeTrack(
                vrm.blendShapeProxy.getBlendShapeTrackName(THREE.VRMSchema.BlendShapePresetName.Blink), // name
                [0.0, 0.5, 1.0], // times
                [0.0, 1.0, 0.0] // values
            );

            const clip = new THREE.AnimationClip('blink', 1.0, [blinkTrack]);
            const action = mixer.clipAction(clip);

            action.play();

            return mixer;
        }*/

        const stats = new Stats();

        stats.domElement.style.position = "absolute";
        stats.domElement.style.top = "0px";

        if (!debug) {
            stats.domElement.classList.add("is-hidden");
        }

        document.body.appendChild(stats.domElement);

        var app = new Vue({
            el: '#app',
            data: {
                isReady: false,
                isLoading: false,
                isRevealed: false,
                user: null,
                input: '',
                currentInputLength: 0,
                maxInputLength: 100,
                inputHasError: false,
                messages: [],
                maxMessages: 10,
                scrollRequired: false,
                words: -1,
                likes: -1,
                notification: null,
                animations: null,
                animationsQueue: [],
                currentAnimations: []
            },
            methods: {
                send: async function (event) {
                    if (this.input.length > 0 && this.input.length <= this.maxInputLength) {
                        function format(format) {
                            var args = arguments;

                            return format.replace(/\{(\d)\}/g, function (m, c) { return args[parseInt(c) + 1] });
                        }

                        const url = 'https://api.milchchan.com/talk?text=' + decodeURIComponent(this.input) + '&threshold=1.0';

                        let ref = database.ref(databaseMessages).push();

                        ref.set({ text: this.input, timestamp: Math.floor(new Date() / 1000), user: { id: app.user.uid, name: null, accent: null, image: null } });

                        let tokens = segmenter.segment(this.input);
                        let completed = 0;
                        let learned = 0;

                        for (let token of tokens) {
                            database.ref(databaseRoot + "/dictionary/words/" + token).transaction(function (word) {
                                if (word === null) {
                                    return ref.key;
                                }

                                return;
                            }, function (error, committed, snapshot) {
                                if (committed) {
                                    learned++;
                                    database.ref(databaseRoot + "/dictionary/count").transaction(function (count) {
                                        return (count || 0) + 1;
                                    });
                                } else if (error) {
                                    console.error(error);
                                }

                                completed++;

                                if (completed == tokens.length && learned > 0) {
                                    app.notification = { text: format(channel.length == 0 ? '{0}つのことばを覚えたよぉ' : '{0}つのことばを覚えたよ', learned), accent: merku.accent, image: channel.length == 0 ? merku.image : null };

                                    window.setTimeout(async function () {
                                        app.notification = null;
                                    }, 3000);

                                    window.pJSDom[0].pJS.fn.modes.pushParticles(learned);
                                }
                            });
                        }

                        this.input = '';
                        this.currentInputLength = 0;

                        if (channel.length > 0) {
                            return;
                        }

                        try {
                            this.isLoading = true;

                            const response = await fetch(url, {
                                mode: "cors",
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded"
                                }
                            });

                            if (response.ok) {
                                const json = await response.json();

                                if (json.text.length > 0) {
                                    database.ref(databaseMessages).push({ text: json.text, timestamp: Math.floor(new Date() / 1000), user: { id: null, name: milch.name, accent: milch.accent, image: milch.image } });
                                }
                            }
                            else {
                                throw new Error(response.statusText);
                            }

                            this.isLoading = false;
                        }
                        catch (e) {
                            this.isLoading = false;

                            app.notification = { text: channel.length == 0 ? 'もう一度試してほしいよぉ' : 'もう一度試してみてね', accent: merku.accent, image: channel.length == 0 ? merku.image : null };

                            window.setTimeout(async function () {
                                app.notification = null;
                            }, 3000);

                            console.error(e.message);
                        }
                    }
                },
                change: function (event) {
                    this.currentInputLength = this.input.length;

                    if (this.currentInputLength <= this.maxInputLength) {
                        this.inputHasError = false;
                    } else {
                        this.inputHasError = true;
                    }
                },
                like: function () {
                    /*if (this.isLearning) {
                        this.messages.push({ id: this.messages.length, text: 'また今度教えてね', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                        this.isLearning = false;
                    } else {
                        this.messages.push({ id: this.messages.length, text: '最初にミルヒちゃんに送るメッセージを教えて欲しいよぉ', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                        this.isLearning = true;
                    }

                    this.scrollRequired = true;
                    */
                    database.ref(databaseChannel + "/likes").transaction(function (count) {
                        return (count || 0) + 1;
                    });

                    this.animationsQueue.push(this.animations['jump']);
                    /*database.ref(databaseChannel + "likes").once('value', snapshot => {
                        const count = snapshot.val();
            
                        if (count === null) {
                            database.ref(databaseChannel + "likes").update({ 'likes': 1 })
                        }
                        else {
                            database.ref(databaseChannel).update({ 'likes': count + 1 })
                        }
                    });*/

                    this.$el.querySelector("#like").play();
                },
                reveal: function (event) {
                    this.isRevealed = !this.isRevealed;
                },
                scrollToEnd: function () {
                    let container = this.$el.querySelector("#container");

                    container.scrollTop = container.scrollHeight;
                },
                formatDate: function (event) {
                    moment.locale(window.navigator.language);

                    return moment(event).format('LT');
                }
            },
            updated: function () {
                let container = this.$el.querySelector("#container");

                container.style.paddingTop = this.$el.querySelector("#heading").getBoundingClientRect().height + 'px';
                container.style.paddingBottom = this.$el.querySelector("#input").getBoundingClientRect().height + 'px';

                if (this.scrollRequired) {
                    this.scrollToEnd();
                    this.scrollRequired = false;
                }
            },
            created: async function () {
                database.ref(databaseRoot + "/dictionary/count").on('value', snapshot => {
                    const count = snapshot.val();

                    if (count === null) {
                        this.words = 0;
                    } else {
                        this.words = count;
                    }
                });
                database.ref(databaseChannel + "/likes").on('value', snapshot => {
                    const count = snapshot.val();

                    if (count === null) {
                        this.likes = 0;
                    } else {
                        if (this.likes >= 0) {
                            window.pJSDom[0].pJS.fn.modes.pushParticles(1);
                        }

                        this.likes = count;
                    }
                });
                database.ref(databaseMessages).limitToLast(this.maxMessages).on('value', snapshot => {
                    const messageDictionary = snapshot.val();

                    if (messageDictionary) {
                        let isSent = false;
                        let isReceived = false;
                        //let keys = [];

                        for (let key in messageDictionary) {
                            const message = messageDictionary[key];
                            let index = -1;

                            //console.log(date.toISOString());
                            //console.log(date.toLocaleTimeString());

                            for (let i = 0; i < this.messages.length; i++) {
                                if (key === this.messages[i].id) {
                                    index = i;

                                    break;
                                }
                            }

                            if (!message.user.accent) {
                                message.user.accent = user.accent;
                            }

                            if (index >= 0) {
                                this.$set(this.messages, key, { id: key, text: message.text, timestamp: new Date(message.timestamp * 1000), user: message.user });
                            }
                            else {
                                this.messages.push({ id: key, text: message.text, timestamp: new Date(message.timestamp * 1000), user: message.user });

                                if (this.messages.length > this.maxMessages) {
                                    this.messages.shift();
                                }

                                if (this.user.uid === message.user.id) {
                                    isSent = true;
                                } else {
                                    isReceived = true
                                }
                            }

                            //keys.push(key);
                        }

                        /*for (let message of this.messages) {
                            if (!keys.includes(message.id)) {
                                this.$set(this.messages, message.id, message);
                            }
                        }*/

                        this.scrollRequired = true;

                        if (isReceived) {
                            this.$el.querySelector("#recieve").play();
                        } else if (isSent) {
                            this.$el.querySelector("#send").play();
                        }
                    }
                });

                const urls = {
                    idle1: '/models/animations/animation-idle1.json',
                    idle2: '/models/animations/animation-idle2.json',
                    idle3: '/models/animations/animation-idle3.json',
                    idle4: '/models/animations/animation-idle4.json',
                    jump: '/models/animations/animation-jump.json',
                    lose: '/models/animations/animation-lose.json',
                    run: '/models/animations/animation-run.json',
                    walk: '/models/animations/animation-walk.json',
                    win: '/models/animations/animation-win.json'
                };
                let animationDictionary = {};

                try {
                    for (let key in urls) {
                        const response = await fetch(encodeURI(urls[key]), {
                            mode: "cors",
                            method: "GET",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            }
                        });

                        if (response.ok) {
                            const json = await response.json();

                            animationDictionary[key] = json.data;
                        }
                        else {
                            throw new Error(response.statusText);
                        }
                    }

                    this.animations = animationDictionary;
                    this.animationsQueue.push(this.animations['jump']);
                } catch (e) {
                    console.error(e);
                }
            },
            mounted: function () {
                let container = this.$el.querySelector("#container");

                //this.messages.push({ id: -1, text: 'ミルヒだよ', tint: milch.tint, avatar: milch.avatar, author: milch.name, timestamp: new Date() });
                container.style.paddingTop = this.$el.querySelector("#heading").getBoundingClientRect().height + 'px';
                container.style.paddingBottom = this.$el.querySelector("#input").getBoundingClientRect().height + 'px';

                firebase.auth().signInAnonymously().catch(function (error) {
                    console.error(error.code, error.message);
                });
                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        // User is signed in.
                        app.user = user;

                    } else {
                        // User is signed out.
                        app.user = null;
                    }
                });
            },
            destroyed: function () {
                database.ref(databaseRoot + "/dictionary/count").off('value')
                database.ref(databaseChannel + "/likes").off('value');
                database.ref(databaseMessages).off('value');
            }
        });

        window.onresize = function (event) {
            let container = app.$el.querySelector("#container");

            container.style.paddingTop = app.$el.querySelector("#heading").getBoundingClientRect().height + 'px';
            container.style.paddingBottom = app.$el.querySelector("#input").getBoundingClientRect().height + 'px';
        };

        particlesJS.load('particles-js', '/js/particlesjs-config.json', function () {
            app.isReady = true;
        });

        const clock = new THREE.Clock();

        let animationIndex = 0;
        const animationSkipFrames = 2;
        let idleTime = null;
        let blendShapeAnimations = [];
        let blendShapeAnimationQueue = [];
        const blinkThreshold = 5.0;

        function render() {
            requestAnimationFrame(render);

            const deltaTime = clock.getDelta();

            if (currentVrm && app.animations) {
                let messageData;

                if (app.currentAnimations.length > 0 && animationIndex < app.currentAnimations.length) {
                    messageData = app.currentAnimations[animationIndex];
                    animationIndex += animationSkipFrames;

                    if (idleTime !== null) {
                        idleTime += deltaTime;

                        if (idleTime >= blinkThreshold) {
                            const maxBlinkSteps = [1.0, 2.0];
                            const maxStep = maxBlinkSteps[random(0, 1)];

                            blendShapeAnimationQueue.push([{ name: THREE.VRMSchema.BlendShapePresetName.BlinkL, step: 0.0, max: maxStep, speed: 2.0 }, { name: THREE.VRMSchema.BlendShapePresetName.BlinkR, step: 0.0, max: maxStep, speed: 2.0 }]);
                            idleTime = 0.0;
                        }
                    }
                } else {
                    app.currentAnimations.splice(0);

                    if (app.animationsQueue.length > 0) {
                        for (let animation of app.animationsQueue.shift()) {
                            app.currentAnimations.push(animation);
                        }

                        idleTime = null;
                    } else {
                        for (let animation of app.animations['idle1']) {
                            app.currentAnimations.push(animation);
                        }

                        if (idleTime === null) {
                            idleTime = 0.0;
                        } else {
                            idleTime += deltaTime;

                            if (idleTime >= blinkThreshold) {
                                const maxBlinkSteps = [1.0, 2.0];
                                const maxStep = maxBlinkSteps[random(0, 1)];

                                blendShapeAnimationQueue.push([{ name: THREE.VRMSchema.BlendShapePresetName.BlinkL, step: 0.0, max: maxStep, speed: 2.0 }, { name: THREE.VRMSchema.BlendShapePresetName.BlinkR, step: 0.0, max: maxStep, speed: 2.0 }]);
                                idleTime = 0.0;
                            }
                        }
                    }

                    animationIndex = 0;
                    messageData = app.currentAnimations[animationIndex];
                    animationIndex += animationSkipFrames;
                }

                if (blendShapeAnimations.length == 0 && blendShapeAnimationQueue.length > 0) {
                    for (let blendShapeAnimation of blendShapeAnimationQueue.shift()) {
                        blendShapeAnimations.push(blendShapeAnimation);
                    }
                }

                if (messageData) {
                    for (let animation of messageData.animations) {
                        switch (animation.bone) {
                            case 'chest':
                            case 'head':
                            case 'hips':
                            case 'jaw':
                            case 'leftEye':
                            case 'leftFoot':
                            case 'leftHand':
                            case 'leftIndexDistal':
                            case 'leftIndexIntermediate':
                            case 'leftIndexProximal':
                            case 'leftLittleDistal':
                            case 'leftLittleIntermediate':
                            case 'leftLittleProximal':
                            case 'leftLowerArm':
                            case 'leftLowerLeg':
                            case 'leftMiddleDistal':
                            case 'leftMiddleIntermediate':
                            case 'leftMiddleProximal':
                            case 'leftRingDistal':
                            case 'leftRingIntermediate':
                            case 'leftRingProximal':
                            case 'leftShoulder':
                            case 'leftThumbDistal':
                            case 'leftThumbIntermediate':
                            case 'leftThumbProximal':
                            case 'leftToes':
                            case 'leftUpperArm':
                            case 'leftUpperLeg':
                            case 'neck':
                            case 'rightEye':
                            case 'rightFoot':
                            case 'rightHand':
                            case 'rightIndexDistal':
                            case 'rightIndexIntermediate':
                            case 'rightIndexProximal':
                            case 'rightLittleDistal':
                            case 'rightLittleIntermediate':
                            case 'rightLittleProximal':
                            case 'rightLowerArm':
                            case 'rightLowerLeg':
                            case 'rightMiddleDistal':
                            case 'rightMiddleIntermediate':
                            case 'rightMiddleProximal':
                            case 'rightRingDistal':
                            case 'rightRingIntermediate':
                            case 'rightRingProximal':
                            case 'rightShoulder':
                            case 'rightThumbDistal':
                            case 'rightThumbIntermediate':
                            case 'rightThumbProximal':
                            case 'rightToes':
                            case 'rightUpperArm':
                            case 'rightUpperLeg':
                            case 'spine':
                            case 'upperChest':
                                break;
                            case 'eye.L':
                                animation.bone = 'leftEye';
                                break;
                            case 'foot.L':
                                animation.bone = 'leftFoot';
                                break;
                            case 'hand.L':
                                animation.bone = 'leftHand';
                                break;
                            case 'f_index.03.L':
                                animation.bone = 'leftIndexDistal';
                                break;
                            case 'f_index.02.L':
                                animation.bone = 'leftIndexIntermediate';
                                break;
                            case 'f_index.01.L':
                                animation.bone = 'leftIndexProximal';
                                break;
                            case 'f_pinky.03.L':
                                animation.bone = 'leftLittleDistal';
                                break;
                            case 'f_pinky.02.L':
                                animation.bone = 'leftLittleIntermediate';
                                break;
                            case 'f_pinky.01.L':
                                animation.bone = 'leftLittleProximal';
                                break;
                            case 'lower_arm.L':
                                animation.bone = 'leftLowerArm';
                                break;
                            case 'shin.L':
                                animation.bone = 'leftLowerLeg';
                                break;
                            case 'f_middle.03.L':
                                animation.bone = 'leftMiddleDistal';
                                break;
                            case 'f_middle.02.L':
                                animation.bone = 'leftMiddleIntermediate';
                                break;
                            case 'f_middle.01.L':
                                animation.bone = 'leftMiddleProximal';
                                break;
                            case 'f_ring.03.L':
                                animation.bone = 'leftRingDistal';
                                break;
                            case 'f_ring.02.L':
                                animation.bone = 'leftRingIntermediate';
                                break;
                            case 'f_ring.01.L':
                                animation.bone = 'leftRingProximal';
                                break;
                            case 'shoulder.L':
                                animation.bone = 'leftShoulder';
                                break;
                            case 'thumb_distal.L':
                                animation.bone = 'leftThumbDistal';
                                break;
                            case 'thumb_intermediate.L':
                                animation.bone = 'leftThumbIntermediate';
                                break;
                            case 'thumb_proximal.L':
                                animation.bone = 'leftThumbProximal';
                                break;
                            case 'toe.L':
                                animation.bone = 'leftToes';
                                break;
                            case 'upper_arm.L':
                                animation.bone = 'leftUpperArm';
                                break;
                            case 'thigh.L':
                                animation.bone = 'leftUpperLeg';
                                break;
                            case 'eye.R':
                                animation.bone = 'rightEye';
                                break;
                            case 'foot.R':
                                animation.bone = 'rightFoot';
                                break;
                            case 'hand.R':
                                animation.bone = 'rightHand';
                                break;
                            case 'f_index.03.R':
                                animation.bone = 'rightIndexDistal';
                                break;
                            case 'f_index.02.R':
                                animation.bone = 'rightIndexIntermediate';
                                break;
                            case 'f_index.01.R':
                                animation.bone = 'rightIndexProximal';
                                break;
                            case 'f_pinky.03.R':
                                animation.bone = 'rightLittleDistal';
                                break;
                            case 'f_pinky.02.R':
                                animation.bone = 'rightLittleIntermediate';
                                break;
                            case 'f_pinky.01.R':
                                animation.bone = 'rightLittleProximal';
                                break;
                            case 'lower_arm.R':
                                animation.bone = 'rightLowerArm';
                                break;
                            case 'shin.R':
                                animation.bone = 'rightLowerLeg';
                                break;
                            case 'f_middle.03.R':
                                animation.bone = 'rightMiddleDistal';
                                break;
                            case 'f_middle.02.R':
                                animation.bone = 'rightMiddleIntermediate';
                                break;
                            case 'f_middle.01.R':
                                animation.bone = 'rightMiddleProximal';
                                break;
                            case 'f_ring.03.R':
                                animation.bone = 'rightRingDistal';
                                break;
                            case 'f_ring.02.R':
                                animation.bone = 'rightRingIntermediate';
                                break;
                            case 'f_ring.01.R':
                                animation.bone = 'rightRingProximal';
                                break;
                            case 'shoulder.R':
                                animation.bone = 'rightShoulder';
                                break;
                            case 'thumb_distal.R':
                                animation.bone = 'rightThumbDistal';
                                break;
                            case 'thumb_intermediate.R':
                                animation.bone = 'rightThumbIntermediate';
                                break;
                            case 'thumb_proximal.R':
                                animation.bone = 'rightThumbProximal';
                                break;
                            case 'toe.R':
                                animation.bone = 'rightToes';
                                break;
                            case 'upper_arm.R':
                                animation.bone = 'rightUpperArm';
                                break;
                            case 'thigh.R':
                                animation.bone = 'rightUpperLeg';
                                break;
                            case 'upper_chest':
                                animation.bone = 'upperChest';
                                break;
                            default:
                                animation.bone = null;
                        }

                        if (animation.bone && animation.rotation.length == 4) {
                            try {
                                currentVrm.humanoid.getBoneNode(animation.bone).position.set(animation.position[0], animation.position[1], -animation.position[2]);
                                currentVrm.humanoid.getBoneNode(animation.bone).quaternion.set(-animation.rotation[0], -animation.rotation[1], animation.rotation[2], animation.rotation[3]);
                            } catch (e) {
                                console.log(animation.bone);
                            }
                        }
                    }
                }

                for (let i = blendShapeAnimations.length - 1; i >= 0; i--) {
                    let blendShapeAnimation = blendShapeAnimations[i];

                    if (blendShapeAnimation.step < blendShapeAnimation.max) {
                        blendShapeAnimation.step += deltaTime * blendShapeAnimation.speed;

                        if (blendShapeAnimation.step >= blendShapeAnimation.max) {
                            currentVrm.blendShapeProxy.setValue(blendShapeAnimation.name, 0.0);

                            blendShapeAnimations.splice(i, 1);
                        } else {
                            currentVrm.blendShapeProxy.setValue(blendShapeAnimation.name, Math.abs(Math.sin(Math.PI * blendShapeAnimation.step)));
                        }
                    }
                }

                currentVrm.update(deltaTime);

                /*if (currentMixer) {
                    currentMixer.update(deltaTime);
                }*/

                renderer.render(scene, camera);
            }

            stats.update();
        }

        render();

        const mouseV2 = new THREE.Vector2();
        const mouseRaycaster = new THREE.Raycaster();

        window.addEventListener('resize', (event) => {
            const width = window.innerWidth;
            const height = window.innerHeight;

            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(width, height);

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });
        window.addEventListener('mousemove', (event) => {
            /*if (currentVrm) {
        
                const range = CAMERA_Z * Math.tan(CAMERA_FOV / 360.0 * Math.PI);
                const px = (2.0 * event.clientX - window.innerWidth) / window.innerHeight * range;
                const py = -(2.0 * event.clientY - window.innerHeight) / window.innerHeight * range;
        
                currentVrm.humanoid.getBoneNode(THREE.VRMSchema.HumanoidBoneName.Hips).position.set(px, py, 0.0);
        
            }*/

            lookAtTarget.position.x = 10.0 * ((event.clientX - 0.5 * window.innerWidth) / window.innerHeight);
            lookAtTarget.position.y = -10.0 * ((event.clientY - 0.5 * window.innerHeight) / window.innerHeight);
        });
    </script>
</body>

</html>