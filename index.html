<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ミルヒちゃんねる</title>
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css" type="text/css"
        media="screen" />
    <style>
        [v-cloak] {
            display: none;
        }

        .wf-notosansjapanese {
            font-family: "Noto Sans JP";
        }

        html {
            overflow: hidden;
        }

        body {
            display: flex;
            position: relative;
            overflow: hidden;
            background-color: #f6f6f6;
            margin: 0;
            align-items: center;
            justify-content: center;
            scroll-behavior: smooth;
        }

        #app {
            display: flex;
            z-index: 0;
            position: relative;
            margin: 0;
            height: 100%;
            width: 100%;
            flex-direction: column;
            justify-content: flex-end;
        }

        #container {
            position: relative;
            margin: 0;
            padding: 0px 16px 0px 16px;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }

        #container .column hr {
            margin: 16px 0px 16px 0px;
            padding: 0;
            height: 0;
        }

        #input .columns {
            margin: 0px 0px 0px 0px;
            padding: 16px 0px 16px 0px;
        }

        #input .column {
            padding: 0px 16px 0px 16px;
        }

        #input .control .is-primary {
            background-color: #30c0f5;
        }

        .has-content-centered {
            margin-left: auto;
            margin-right: auto;
        }

        .media-content .level {
            margin: 0px 0px 8px 0px;
        }

        .media-content p {
            word-wrap: break-word;
            white-space: normal;
        }

        .media-content .has-text-left .balloon {
            display: inline-block;
            padding: 8px 16px 8px 16px;
            border-radius: 0px 500px 500px 500px;
            background-image: url('/images/Stripes.png');
            background-repeat: repeat;
        }

        .media-content .has-text-right .balloon {
            display: inline-block;
            padding: 8px 16px 8px 16px;
            border-radius: 500px 0px 500px 500px;
            background-image: url('/images/Stripes.png');
            background-repeat: repeat;
        }

        .navbar {
            background-color: transparent;
        }

        .navbar:first-child {
            position: fixed;
            z-index: 1;
            margin: env(safe-area-inset-top) 0px 0px 0px;
        }

        .navbar:first-child .navbar-item {
            padding: 32px 0px 16px 0px;
        }

        .navbar:last-child {
            z-index: 1;
            padding: 0px env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .navbar:last-child .columns {
            margin: 0px 0px 0px 0px;
            padding: 0px 0px 16px 0px;
        }

        .navbar:last-child .column {
            padding: 0px 0px 0px 0px;
            line-height: 0px;
        }

        .navbar-item img {
            max-height: none;
        }

        .updating {
            animation: updating 1s linear infinite;
        }

        @keyframes updating {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(-360deg);
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio:2),
        (min-resolution: 2dppx) {
            .media-content .has-text-left .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 0px 500px 500px 500px;
                background-image: url('/images/Stripes@2x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }

            .media-content .has-text-right .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 500px 0px 500px 500px;
                background-image: url('/images/Stripes@2x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }
        }

        @media screen and (-webkit-min-device-pixel-ratio:3),
        (min-resolution: 3dppx) {
            .media-content .has-text-left .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 0px 500px 500px 500px;
                background-image: url('/images/Stripes@3x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }

            .media-content .has-text-right .balloon {
                display: inline-block;
                padding: 8px 16px 8px 16px;
                border-radius: 500px 0px 500px 500px;
                background-image: url('/images/Stripes@3x.png');
                background-repeat: repeat;
                background-size: 20px 20px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <nav id="heading" class="navbar is-fixed-top" role="navigation">
            <div class="navbar-item is-expanded columns is-desktop">
                <div class="column is-half has-content-centered" v-cloak>
                    <div class="control has-text-centered">
                        <nav class="level">
                            <div class="level-item has-text-centered">
                                <div>
                                    <p class="heading">教えてもらった会話数</p>
                                    <p class="title is-size-1" v-bind:class="{'is-invisible': trainCount === -1}">
                                        {{ trainCount }}</p>
                                </div>
                            </div>
                        </nav>
                        <button class="button is-white has-background-white has-text-black is-rounded"
                            v-bind:class="{'is-hidden': isLearning}" v-on:click="learn">
                            <span class="icon is-small">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span class="has-text-weight-bold">会話を教える</span>
                        </button>
                        <button class="button is-white has-background-danger has-text-white is-rounded"
                            v-bind:class="{'is-hidden': !isLearning}" v-on:click="learn" v-cloak>
                            <span class="icon is-small">
                                <i class="fas fa-ban"></i>
                            </span>
                            <span class="has-text-weight-bold">学習をキャンセル</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        <div id="container">
            <div class="columns is-desktop" v-for="message in messages" v-bind:key="message.id">
                <div class="column is-half has-content-centered">
                    <hr class="is-invisible">
                    <article class="media" v-if="message.author" v-cloak>
                        <figure class="media-left">
                            <p class="image is-64x64">
                                <img class="is-rounded" v-bind:src="message.avatar" alt="Avatar">
                            </p>
                        </figure>
                        <div class="media-content">
                            <div class="level is-mobile">
                                <div class="level-left">
                                    <span
                                        class="is-size-7 has-text-weight-bold has-text-grey">{{ message.author }}</span>
                                </div>
                            </div>
                            <div class="content has-text-left">
                                <div class="balloon" v-bind:style="{ backgroundColor: message.tint }">
                                    <p class="has-text-weight-bold has-text-white">
                                        <span v-bind:class="{'is-hidden':message.text}">
                                            <i class="fas fa-spinner updating"></i>
                                        </span>
                                        {{ message.text }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </article>
                    <article class="media" v-else v-cloak>
                        <div class="media-content">
                            <div class="content has-text-right">
                                <div class="balloon" v-bind:style="{ backgroundColor: message.tint }">
                                    <p class="has-text-weight-bold has-text-white">
                                        {{ message.text }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <figure class="media-right" v-if="message.avatar">
                            <p class="image is-64x64">
                                <img class="is-rounded" v-bind:src="message.avatar" alt="Avatar">
                            </p>
                        </figure>
                    </article>
                </div>
            </div>
        </div>
        <nav id="input" class="navbar is-fixed-bottom" role="navigation">
            <div class="navbar-item is-expanded columns is-desktop">
                <div class="column is-half has-content-centered">
                    <form onsubmit="return false;">
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <input class="input is-rounded" type="text" v-model="input">
                            </div>
                            <div class="control">
                                <button class="button is-rounded is-primary" type="submit" @click="send"><span
                                        class="icon is-small">
                                        <i class="fas fa-paper-plane"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </nav>
        <audio id="popup" preload="auto">
            <source src="https://chat.milchchan.com/sounds/popup.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-database.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.4/firebase-analytics.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script type="text/javascript">
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDTVxDJj7rqG9L-Clvba2Tao9B0hkcxjcE",
            authDomain: "milchchan.firebaseapp.com",
            databaseURL: "https://milchchan.firebaseio.com",
            projectId: "milchchan",
            storageBucket: "milchchan.appspot.com",
            messagingSenderId: "355698971889",
            appId: "1:355698971889:web:e3653c5c31bd7289cd4550",
            measurementId: "G-3998FJYNWX"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        let databaseRoot = 'chat/';
        let database = firebase.database();
        const user = { tint: '#30c0f5' };
        const milch = { name: 'ミルヒちゃん', tint: '#ffa6bb', avatar: '/images/Milch.png' };
        const merku = { name: 'メルクちゃん', tint: '#5bcbe1', avatar: '/images/Merku.png' };

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        var app = new Vue({
            el: '#app',
            data: {
                input: '',
                messages: [],
                scrollRequired: false,
                isLearning: false,
                trainCount: -1
            },
            methods: {
                send: function (event) {
                    if (this.input.length > 0) {
                        if (this.isLearning) {
                            if ('source' in this.messages[this.messages.length - 1]) {
                                let trainData = { source: this.messages[this.messages.length - 1].source, target: this.input, timestamp: new Date().toISOString() };

                                this.messages.push({ id: this.messages.length, text: this.input, tint: user.tint, timestamp: new Date() });
                                this.messages.push({ id: this.messages.length, text: '教えてくれて嬉しいよぉ！また教えてね', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });

                                database.ref(databaseRoot + 'train').push(trainData);
                                database.ref(databaseRoot + "train_count").once('value', snapshot => {
                                    const count = snapshot.val();

                                    if (count === null) {
                                        database.ref(databaseRoot).update({ 'train_count': 1 })
                                    }
                                    else {
                                        database.ref(databaseRoot).update({ 'train_count': count + 1 })
                                    }
                                });

                                this.isLearning = false;
                            } else {
                                this.messages.push({ id: this.messages.length, text: this.input, tint: user.tint, timestamp: new Date() });
                                this.messages.push({ id: this.messages.length, text: '次にミルヒちゃんに言ってもらいたいことを教えて欲しいよぉ', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date(), source: this.input });
                            }

                            this.input = '';
                            this.scrollRequired = true;
                            this.$el.querySelector("#popup").play();
                        } else {
                            let log = { input: this.input };
                            const url = 'https://api.milchchan.com/talk?text=' + this.input + '&threshold=0.9';

                            this.messages.push({ id: this.messages.length, text: this.input, tint: user.tint, timestamp: new Date() });
                            this.input = '';
                            this.scrollRequired = true;

                            window.setTimeout(async function () {
                                let replyMessage = { id: app.messages.length, text: null, tint: milch.tint, avatar: milch.avatar, author: milch.name, timestamp: null };

                                app.messages.push(replyMessage);
                                app.scrollRequired = true;

                                try {
                                    const response = await fetch(encodeURI(url), {
                                        mode: "cors",
                                        method: "GET",
                                        headers: {
                                            "Content-Type": "application/x-www-form-urlencoded"
                                        }
                                    });

                                    if (response.ok) {
                                        const json = await response.json();

                                        if (json.text.length > 0) {
                                            replyMessage.text = json.text;
                                            replyMessage.timestamp = Date.parse(json.timestamp);

                                            app.$set(app.messages, replyMessage.id, replyMessage);
                                        }
                                        else {
                                            var index = -1;
                                            var i = 0;

                                            for (let message of app.messages) {
                                                if (message.id === replyMessage.id) {
                                                    index = i;

                                                    break;
                                                }

                                                i++;
                                            }

                                            if (index >= 0) {
                                                app.messages.splice(index, 1);
                                            }

                                            app.messages.push({ id: app.messages.length, text: 'ミルヒちゃん、困ってるみたいだからメッセージを変えて送るといいと思うよぉ', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                                        }

                                        app.scrollRequired = true;
                                        app.$el.querySelector("#popup").play();

                                        log.output = json.text;
                                        log.timestamp = new Date().toISOString();

                                        database.ref(databaseRoot + "logs").push(log);
                                    }
                                    else {
                                        throw new Error(response.statusText);
                                    }
                                }
                                catch (e) {
                                    var index = -1;
                                    var i = 0;

                                    for (let message of app.messages) {
                                        if (message.id === replyMessage.id) {
                                            index = i;

                                            break;
                                        }

                                        i++;
                                    }

                                    if (index >= 0) {
                                        app.messages.splice(index, 1);
                                    }

                                    app.messages.push({ id: app.messages.length, text: 'エラーだよぉ', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                                    app.scrollRequired = true;
                                    app.$el.querySelector("#popup").play();
                                }
                            }, random(500, 1000));
                        }
                    }
                },
                learn: function () {
                    if (this.isLearning) {
                        this.messages.push({ id: this.messages.length, text: 'また今度教えてね', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                        this.isLearning = false;
                    } else {
                        this.messages.push({ id: this.messages.length, text: '最初にミルヒちゃんに送るメッセージを教えて欲しいよぉ', tint: merku.tint, avatar: merku.avatar, author: merku.name, timestamp: new Date() });
                        this.isLearning = true;
                    }

                    this.scrollRequired = true;
                    this.$el.querySelector("#popup").play();
                },
                scrollToEnd: function () {
                    let container = this.$el.querySelector("#container");

                    container.scrollTop = container.scrollHeight;
                }
            },
            updated: function () {
                let container = this.$el.querySelector("#container");

                container.style.paddingTop = this.$el.querySelector("#heading").getBoundingClientRect().height + 'px';
                container.style.paddingBottom = this.$el.querySelector("#input").getBoundingClientRect().height + 'px';

                if (this.scrollRequired) {
                    this.scrollToEnd();
                    this.scrollRequired = false;
                }
            },
            mounted: function () {
                let container = this.$el.querySelector("#container");

                this.messages.push({ id: -1, text: 'ミルヒだよ', tint: milch.tint, avatar: milch.avatar, author: milch.name, timestamp: new Date() });
                container.style.paddingTop = this.$el.querySelector("#heading").getBoundingClientRect().height + 'px';
                container.style.paddingBottom = this.$el.querySelector("#input").getBoundingClientRect().height + 'px';
                this.scrollRequired = true;
                this.$el.querySelector("#popup").play();

                database.ref(databaseRoot + "train_count").on('value', snapshot => {
                    const count = snapshot.val();

                    if (count !== null) {
                        this.trainCount = count;
                    } else {
                        this.trainCount = 0;
                    }
                });
            }
        });
    </script>
</body>

</html>